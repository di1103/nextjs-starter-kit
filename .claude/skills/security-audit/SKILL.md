---
name: security-audit
description: 実装完了時にセキュリティ観点でコードを診断し、脆弱性を検出するスキル。認証・認可、入力検証、データ漏洩、インジェクション対策、設定をチェック。「セキュリティ診断して」「セキュリティ監査して」などの指示で起動。
---

# セキュリティ診断スキル

実装完了時にセキュリティ観点でコードを診断し、脆弱性を検出するスキルです。

---

## 診断フロー

```
Step 1: 対象ファイル特定
    → Step 2: 自動診断チェック
    → Step 3: 診断レポート生成
```

---

## Step 1: 対象ファイルの特定

```
Task(subagent_type="Explore")
├── lib/actions/*.ts
├── app/api/**/*.ts
├── lib/db/schemas/*.ts
└── app/**/components/*.tsx
```

---

## Step 2: 診断チェック

### チェックリスト

| ID | カテゴリ | チェック項目 | 重大度 |
|----|---------|-------------|--------|
| AUTH-1 | 認証 | Server Actionsに認証チェックがあるか | Critical |
| AUTH-4 | 認証 | 他ユーザーのデータにアクセスできないか | Critical |
| INPUT-1 | 入力 | Zodで検証しているか | High |
| INPUT-2 | 入力 | 検証前のデータをDBに渡していないか | Critical |
| LEAK-1 | 漏洩 | パスワードハッシュを返していないか | Critical |
| LEAK-3 | 漏洩 | エラーで内部情報を露出していないか | Medium |
| INJ-1 | 注入 | SQLインジェクション対策 | Critical |
| INJ-2 | 注入 | XSS対策 | High |
| CONFIG-1 | 設定 | シークレットがハードコードされていないか | Critical |
| CONFIG-3 | 設定 | NEXT_PUBLIC_ の使い分けが適切か | High |

チェックパターン → [references/check-patterns.md](references/check-patterns.md)

---

## Step 3: 診断レポート生成

```markdown
## セキュリティ診断レポート

**診断日時**: YYYY-MM-DD HH:MM
**対象**: [設計書名 / 機能名]

### サマリー

| 重大度 | 件数 | 対応 |
|--------|------|------|
| Critical | X | 即時対応必須 |
| High | X | 対応推奨 |
| Medium | X | 検討 |
| Low | X | 任意 |

### 検出項目

#### Critical
- [INJ-1] SQLインジェクションの危険
  - ファイル: `lib/actions/xxx.ts:25`
  - 問題: 生SQLクエリでユーザー入力を直接使用
  - 修正: Drizzle ORMのクエリビルダーを使用

### 対応不要（確認済み）
| ID | 項目 | 確認結果 |
|----|------|---------|
| AUTH-1 | 認証チェック | ✅ 全Actions実装済み |
```

---

## 重大度の定義

| 重大度 | 定義 | 対応 |
|--------|------|------|
| Critical | 即座に悪用可能（認証バイパス、SQLi等） | **実装完了前に必ず修正** |
| High | 悪用可能性が高い（権限昇格、データ漏洩等） | 実装完了前に修正推奨 |
| Medium | 条件付きで悪用可能（情報露出等） | 次回リリースまでに修正 |
| Low | ベストプラクティス違反 | 任意で対応 |

---

## スキップ条件

以下の場合は診断スキップ可能:
- UIのみの変更（スタイル・レイアウト）
- ドキュメントのみ（.md）
- テストのみ（.test.ts, .spec.ts）

---

## 注意事項

- Critical 項目が残っている場合、実装完了としない
- 診断レポートは `docs/progress/security-audit/` に保存
- 本番デプロイ前に必ず再診断を実行
