# DBマイグレーションスキル

Drizzle ORMを用いたデータベースのマイグレーションを支援するスキルです。

---

## 実行タイミング

ユーザーから以下のような指示を受けたとき:
- 「テーブルを追加して」
- 「カラムを追加して」
- 「DBスキーマを変更して」
- 「マイグレーションして」

---

## 実行フロー

```
┌─────────────────────────────────────────────────────────────┐
│  Step 1: 変更内容ヒアリング                                  │
└─────────────────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────────────────┐
│  Step 2: スキーマ編集                                        │
└─────────────────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────────────────┐
│  Step 3: マイグレーション実行（ユーザー手動）                 │
└─────────────────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────────────────┐
│  Step 4: 検証                                                │
└─────────────────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────────────────┐
│  Step 5: 設計書更新（任意）                                  │
└─────────────────────────────────────────────────────────────┘
```

---

## Step 1: 変更内容ヒアリング

以下を確認する:

| 項目 | 選択肢 |
|------|--------|
| 操作対象 | テーブル / カラム |
| 操作種別 | 追加 / 変更 / 削除 |
| 対象名 | テーブル名・カラム名 |
| 追加の場合 | 型、制約、デフォルト値 |

---

## Step 2: スキーマ編集

`lib/db/schemas/` 配下の適切なファイルを編集:

### 新規テーブル

1. `lib/db/schemas/[テーブル名].ts` を作成
2. `lib/db/schemas/index.ts` にエクスポート追加

```typescript
// lib/db/schemas/products.ts
import { pgTable, text, integer, timestamp } from "drizzle-orm/pg-core";

export const products = pgTable("products", {
  id: text("id").primaryKey(),
  name: text("name").notNull(),
  price: integer("price").notNull(),
  createdAt: timestamp("created_at").defaultNow().notNull(),
  updatedAt: timestamp("updated_at").defaultNow().notNull(),
});
```

```typescript
// lib/db/schemas/index.ts
export * from "./auth-schema";
export * from "./products";  // 追加
```

### カラム追加・変更

既存ファイルを編集

### 削除

ファイル削除または該当行を削除、`index.ts` から削除

---

## Step 3: マイグレーション実行（ユーザー手動）

**重要**: `pnpm db:push` は対話式プロンプトがあるため、自動実行できません。

ユーザーに以下を伝えて手動実行を依頼:

```
マイグレーションを手動で実行してください：

pnpm db:push

対話式の質問が出た場合：
- 「create column」または「rename column」を選択
- truncate の質問には「No」を選択（既存データを保持）
```

**ここで作業を一時停止し、ユーザーからの報告を待つ。**

---

## Step 4: 検証

マイグレーション実行後、結果を確認:

### テーブル一覧確認

```sql
SELECT tablename FROM pg_tables
WHERE schemaname = 'public'
ORDER BY tablename;
```

### カラム構造確認

```sql
SELECT column_name, data_type, is_nullable, column_default
FROM information_schema.columns
WHERE table_name = '[テーブル名]'
ORDER BY ordinal_position;
```

### 確認項目

- [ ] 対象テーブル/カラムが存在するか
- [ ] 型・制約が期待通りか
- [ ] 既存データに影響がないか

---

## Step 5: 設計書更新（任意）

該当する設計書があれば更新:

- `docs/design/features/[機能名].md` のDB設計セクション
- `docs/design/index.md` のテーブル一覧

---

## エラー時の対応

| エラー | 対応 |
|--------|------|
| マイグレーション失敗 | エラーメッセージを確認し、スキーマを修正して再実行 |
| 外部キー制約エラー | 制約を先に削除してからカラム変更 |
| データ損失警告 | 既存データを移行するSQLを手動で実行 |

---

## 報告内容

実行完了後、以下を報告:

- 変更したファイル一覧
- DBテーブル/カラムの変更内容
- 検証結果

---

## 注意事項

- 本番環境への適用は慎重に（Vercel環境変数の `DATABASE_URL` はPooler接続）
- 破壊的変更（カラム削除、型変更）は既存データに影響するため要確認
- Git コミットはユーザー判断に委ねる
